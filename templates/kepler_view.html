{% extends "base.html" %}

{% block title %}Kepler.gl Visualization - {{ city.name }}{% endblock %}

{% block extra_css %}
<style>
    .kepler-container {
        background: rgba(61, 43, 79, 0.1);
        border: 1px solid rgba(138, 125, 149, 0.3);
        border-radius: 12px;
        padding: 1.5rem;
        backdrop-filter: blur(10px);
        margin-bottom: 2rem;
    }
    
    .data-preview {
        background: rgba(61, 43, 79, 0.2);
        border: 1px solid rgba(138, 125, 149, 0.5);
        border-radius: 8px;
        padding: 1rem;
        margin: 1rem 0;
        font-family: 'Courier New', monospace;
        font-size: 0.875rem;
        max-height: 300px;
        overflow-y: auto;
    }
    
    .step-indicator {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        margin-bottom: 1rem;
        padding: 0.75rem;
        background: rgba(61, 43, 79, 0.2);
        border-radius: 8px;
        border-left: 4px solid var(--accent-purple);
    }
    
    .step-number {
        background: var(--accent-purple);
        color: white;
        width: 24px;
        height: 24px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        font-size: 0.875rem;
    }
    
    .btn-primary {
        background: var(--accent-purple);
        color: white;
        padding: 0.75rem 1.5rem;
        border-radius: 8px;
        font-weight: 600;
        transition: all 0.3s;
        border: none;
        cursor: pointer;
    }
    
    .btn-primary:hover {
        background: #7c3aed;
        transform: translateY(-1px);
    }
    
    .btn-secondary {
        background: #374151;
        color: white;
        padding: 0.75rem 1.5rem;
        border-radius: 8px;
        font-weight: 600;
        transition: all 0.3s;
        border: none;
        cursor: pointer;
    }
    
    .btn-secondary:hover {
        background: #4b5563;
        transform: translateY(-1px);
    }
    
    .btn-success {
        background: #059669;
        color: white;
        padding: 0.75rem 1.5rem;
        border-radius: 8px;
        font-weight: 600;
        transition: all 0.3s;
        border: none;
        cursor: pointer;
    }
    
    .btn-success:hover {
        background: #047857;
        transform: translateY(-1px);
    }
    
    .status-message {
        padding: 1rem;
        border-radius: 8px;
        margin: 1rem 0;
        font-weight: 500;
    }
    
    .status-success {
        background: rgba(5, 150, 105, 0.2);
        border: 1px solid #059669;
        color: #10b981;
    }
    
    .status-error {
        background: rgba(239, 68, 68, 0.2);
        border: 1px solid #ef4444;
        color: #f87171;
    }
    
    .status-info {
        background: rgba(59, 130, 246, 0.2);
        border: 1px solid #3b82f6;
        color: #60a5fa;
    }
    
    .kepler-map-container {
        height: 600px;
        width: 100%;
        border-radius: 8px;
        overflow: hidden;
        border: 2px solid rgba(138, 125, 149, 0.3);
        position: relative;
    }
    
    .loading-spinner {
        display: flex;
        align-items: center;
        justify-content: center;
        height: 100%;
        color: white;
    }
    
    .spinner {
        border: 4px solid rgba(138, 125, 149, 0.3);
        border-top: 4px solid var(--accent-purple);
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
</style>
{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto">
  <header class="text-center mb-8">
    <img src="{{ url_for('static', filename='sante_logo.png') }}" alt="Sant√© Logo" class="mx-auto h-16 w-auto mb-4">
    <h1 class="text-3xl font-bold text-text-light mb-2">üó∫Ô∏è Kepler.gl Geospatial Visualization</h1>
    <p class="text-border-subtle text-lg">Advanced mapping for: {{ city.name }}{% if city.state %}, {{ city.state }}{% endif %}{% if city.country %}, {{ city.country }}{% endif %}</p>
  </header>

  <!-- Step 1: Data Processing with OpenAI -->
  <div class="kepler-container">
    <div class="step-indicator">
      <div class="step-number">1</div>
      <div>
        <h3 class="text-lg font-semibold text-text-light">Process Data with OpenAI</h3>
        <p class="text-sm text-border-subtle">Transform epidemiological data into Kepler.gl compatible format</p>
      </div>
    </div>
    
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
      <div>
        <h4 class="text-md font-medium text-text-light mb-3">Current Data Summary</h4>
        <div class="data-preview">
          <div><strong>City:</strong> {{ city.name }}, {{ city.state }}, {{ city.country }}</div>
          <div><strong>R(t):</strong> {{ "%.2f"|format(ind.rt) }}</div>
          <div><strong>R0:</strong> {{ "%.2f"|format(ind.r0) }}</div>
          <div><strong>Hospitalization Rate:</strong> {{ "%.1f"|format(ind.hospitalization_rate) }}%</div>
          <div><strong>Data Points:</strong> {{ kepler_data|length }} weeks</div>
          <div><strong>Coordinates:</strong> {{ kepler_data[0].latitude if kepler_data else 'N/A' }}, {{ kepler_data[0].longitude if kepler_data else 'N/A' }}</div>
        </div>
      </div>
      
      <div>
        <h4 class="text-md font-medium text-text-light mb-3">AI Processing</h4>
        <p class="text-sm text-border-subtle mb-4">Click the button below to process the data with OpenAI and prepare it for Kepler.gl visualization.</p>
        
        <form method="POST" action="{{ url_for('dashboard.process_kepler_data', city_id=city.id) }}" class="space-y-3">
          <button type="submit" class="btn-primary w-full">
            ü§ñ Process with OpenAI
          </button>
        </form>
        
        {% if processed_data %}
        <div class="status-success status-message">
          ‚úÖ Data processed successfully! Ready for Kepler.gl visualization.
        </div>
        {% endif %}
        
        {% if error_message %}
        <div class="status-error status-message">
          ‚ùå Error: {{ error_message }}
        </div>
        {% endif %}
      </div>
    </div>
  </div>

  <!-- Step 2: Kepler.gl Visualization -->
  <div class="kepler-container">
    <div class="step-indicator">
      <div class="step-number">2</div>
      <div>
        <h3 class="text-lg font-semibold text-text-light">Kepler.gl Interactive Map</h3>
        <p class="text-sm text-border-subtle">Explore the epidemiological data in an advanced geospatial visualization</p>
      </div>
    </div>
    
    {% if processed_data %}
    <div class="mb-4 flex gap-3">
      <button id="load-kepler-btn" class="btn-success">
        üó∫Ô∏è Load Kepler.gl Map
      </button>
      <button id="download-data-btn" class="btn-secondary">
        üíæ Download Processed Data
      </button>
      <a href="{{ url_for('dashboard.view_city', city_id=city.id) }}" class="btn-secondary">
        ‚Üê Back to Dashboard
      </a>
    </div>
    
    <div id="kepler-map" class="kepler-map-container">
      <div class="loading-spinner">
        <div>
          <div class="spinner mb-4"></div>
          <p class="text-lg">Click "Load Kepler.gl Map" to start visualization</p>
        </div>
      </div>
    </div>
    {% else %}
    <div class="text-center py-8">
      <div class="status-info status-message">
        ‚ÑπÔ∏è Please process the data with OpenAI first to enable Kepler.gl visualization.
      </div>
      <p class="text-border-subtle mt-4">The AI will format the epidemiological data to be compatible with Kepler.gl's advanced mapping capabilities.</p>
    </div>
    {% endif %}
  </div>

  <!-- Data Preview Section -->
  {% if processed_data %}
  <div class="kepler-container">
    <h3 class="text-lg font-semibold text-text-light mb-4">Processed Data Preview</h3>
    <div class="data-preview">
      <pre>{{ processed_data|tojson(indent=2) }}</pre>
    </div>
  </div>
  {% endif %}
</div>

<!-- Kepler.gl Dependencies -->
<script src="https://unpkg.com/react@18.3.1/umd/react.production.min.js" crossorigin></script>
<script src="https://unpkg.com/react-dom@18.3.1/umd/react-dom.production.min.js" crossorigin></script>
<script src="https://unpkg.com/redux@4.2.1/dist/redux.js" crossorigin></script>
<script src="https://unpkg.com/react-redux@8.1.2/dist/react-redux.min.js" crossorigin></script>
<script src="https://unpkg.com/styled-components@6.1.8/dist/styled-components.min.js" crossorigin></script>
<script src="https://unpkg.com/kepler.gl@3.0.0/umd/keplergl.min.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function () {
  let keplerStore = null;
  let keplerComponent = null;
  
  // Load Kepler.gl Map
  document.getElementById('load-kepler-btn')?.addEventListener('click', function() {
    if (keplerStore) return; // Already initialized
    
    try {
      console.log('Initializing Kepler.gl...');
      
      // Check if Kepler.gl is available
      if (typeof KeplerGl === 'undefined') {
        throw new Error('Kepler.gl not loaded');
      }
      
      const keplerMap = document.getElementById('kepler-map');
      
      // Get processed data from Flask template
      const cityData = {{ processed_data|tojson if processed_data else '[]' }};
      console.log('Processed city data for Kepler.gl:', cityData);
      
      if (!cityData || cityData.length === 0) {
        throw new Error('No processed data available');
      }
      
      // Create Redux store for Kepler.gl
      const reducers = Redux.combineReducers({
        keplerGl: KeplerGl.keplerGlReducer
      });
      
      const middlewares = KeplerGl.enhanceReduxMiddleware([]);
      const enhancers = Redux.applyMiddleware(...middlewares);
      keplerStore = Redux.createStore(reducers, {}, Redux.compose(enhancers));
      
      // Create Kepler.gl component
      const KeplerElement = React.createElement('div', {
        style: {position: 'absolute', left: 0, width: '100%', height: '100%'}
      }, React.createElement(KeplerGl.KeplerGl, {
        id: 'kepler-map',
        width: keplerMap.offsetWidth,
        height: keplerMap.offsetHeight,
        mapboxApiAccessToken: 'pk.eyJ1IjoibWFwYm94IiwiYSI6ImNpejY4NXVycTA2emYycXBndHRqcmZ3N3gifQ.rJcFIG214AriISLbB6B5aw'
      }));
      
      const app = React.createElement(ReactRedux.Provider, {store: keplerStore}, KeplerElement);
      
      const root = ReactDOM.createRoot(keplerMap);
      root.render(app);
      keplerComponent = root;
      
      console.log('Kepler.gl component rendered successfully');
      
      // Load data into Kepler.gl after component is mounted
      setTimeout(() => {
        if (cityData && cityData.length > 0) {
          loadDataIntoKepler(cityData);
        }
      }, 2000);
      
    } catch (error) {
      console.error('Error initializing Kepler.gl:', error);
      const keplerMap = document.getElementById('kepler-map');
      keplerMap.innerHTML = `
        <div style="display: flex; align-items: center; justify-content: center; height: 100%; color: white; text-align: center;">
          <div>
            <h3>Erro ao carregar Kepler.gl</h3>
            <p>${error.message}</p>
            <p>Verifique o console para mais detalhes.</p>
          </div>
        </div>
      `;
    }
  });
  
  // Download Processed Data
  document.getElementById('download-data-btn')?.addEventListener('click', function() {
    const cityData = {{ processed_data|tojson if processed_data else '[]' }};
    if (cityData && cityData.length > 0) {
      const dataStr = JSON.stringify(cityData, null, 2);
      const dataBlob = new Blob([dataStr], {type: 'application/json'});
      const url = URL.createObjectURL(dataBlob);
      const link = document.createElement('a');
      link.href = url;
      link.download = '{{ city.name.lower().replace(" ", "_") }}_kepler_data.json';
      link.click();
      URL.revokeObjectURL(url);
    }
  });
  
  function loadDataIntoKepler(cityData) {
    try {
      console.log('Loading data into Kepler.gl...');
      
      // Convert data to Kepler.gl format
      const keplerDataset = {
        data: cityData,
        info: {
          id: 'city-epidemiological-data',
          label: 'City Epidemiological Data',
          columns: [
            {name: 'week', type: 'string'},
            {name: 'cases', type: 'integer'},
            {name: 'city_name', type: 'string'},
            {name: 'state', type: 'string'},
            {name: 'country', type: 'string'},
            {name: 'latitude', type: 'real'},
            {name: 'longitude', type: 'real'},
            {name: 'rt', type: 'real'},
            {name: 'r0', type: 'real'},
            {name: 'hospitalization_rate', type: 'real'}
          ]
        }
      };
      
      // Try to load data into Kepler.gl
      if (keplerStore && typeof KeplerGl.addDataToMap !== 'undefined') {
        keplerStore.dispatch(KeplerGl.addDataToMap({
          datasets: [keplerDataset],
          options: {
            autoCreateLayers: true,
            centerMap: true
          }
        }));
        console.log('Data loaded into Kepler.gl successfully');
      } else if (keplerStore && KeplerGl.actions && KeplerGl.actions.addDataToMap) {
        keplerStore.dispatch(KeplerGl.actions.addDataToMap({
          datasets: [keplerDataset],
          options: {
            autoCreateLayers: true,
            centerMap: true
          }
        }));
        console.log('Data loaded using actions approach');
      } else {
        console.log('Kepler.gl data loading APIs not available');
        showDataOverlay(cityData);
      }
      
    } catch (error) {
      console.error('Error loading data into Kepler.gl:', error);
      showDataOverlay(cityData);
    }
  }
  
  function showDataOverlay(cityData) {
    const keplerMap = document.getElementById('kepler-map');
    const overlay = document.createElement('div');
    overlay.style.cssText = `
      position: absolute;
      top: 10px;
      right: 10px;
      background: rgba(61, 43, 79, 0.9);
      border: 1px solid #8a7d95;
      border-radius: 8px;
      padding: 15px;
      color: white;
      max-width: 300px;
      z-index: 1000;
      font-size: 12px;
    `;
    
    overlay.innerHTML = `
      <h4 style="margin: 0 0 10px 0; color: #8a7d95;">üìä Dados Epidemiol√≥gicos</h4>
      <div style="margin-bottom: 10px;">
        <strong>${cityData[0].city_name}, ${cityData[0].state}</strong><br>
        R(t): ${cityData[0].rt} | R0: ${cityData[0].r0}<br>
        Hospitaliza√ß√£o: ${cityData[0].hospitalization_rate}%
      </div>
      <div style="font-size: 11px; color: #8a7d95;">
        ${cityData.length} semanas de dados carregadas
      </div>
    `;
    
    keplerMap.appendChild(overlay);
  }
});
</script>
{% endblock %}
