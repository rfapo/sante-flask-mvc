<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Kepler.gl with Epidemiological Data Test</title>
    <style>
        body { margin: 0; padding: 0; }
        #map { width: 100vw; height: 100vh; }
        .controls { position: absolute; top: 10px; left: 10px; z-index: 1000; background: white; padding: 10px; border-radius: 5px; }
    </style>
</head>
<body>
    <div class="controls">
        <h3>Kepler.gl Test with City Data</h3>
        <button onclick="loadSampleData()">Load Sample City Data</button>
        <button onclick="clearData()">Clear Data</button>
    </div>
    <div id="map"></div>

    <!-- Kepler.gl Dependencies -->
    <script src="https://unpkg.com/react@18.3.1/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18.3.1/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/redux@4.2.1/dist/redux.js" crossorigin></script>
    <script src="https://unpkg.com/react-redux@8.1.2/dist/react-redux.min.js" crossorigin></script>
    <script src="https://unpkg.com/styled-components@6.1.8/dist/styled-components.min.js" crossorigin></script>
    
    <!-- Kepler.gl UMD Bundle -->
    <script src="https://unpkg.com/kepler.gl@3.1.0/umd/keplergl.min.js"></script>

    <script>
        let keplerStore = null;
        let keplerComponent = null;

        // Sample epidemiological data (similar to what Flask would pass)
        const sampleCityData = [
            {
                week: 'Wk 40',
                cases: 45,
                city_name: 'New York',
                state: 'NY',
                country: 'USA',
                latitude: 40.7128,
                longitude: -74.0060,
                rt: 1.15,
                r0: 1.3,
                hospitalization_rate: 5.8
            },
            {
                week: 'Wk 41',
                cases: 52,
                city_name: 'New York',
                state: 'NY',
                country: 'USA',
                latitude: 40.7128,
                longitude: -74.0060,
                rt: 1.15,
                r0: 1.3,
                hospitalization_rate: 5.8
            },
            {
                week: 'Wk 42',
                cases: 48,
                city_name: 'New York',
                state: 'NY',
                country: 'USA',
                latitude: 40.7128,
                longitude: -74.0060,
                rt: 1.15,
                r0: 1.3,
                hospitalization_rate: 5.8
            },
            {
                week: 'Wk 43',
                cases: 61,
                city_name: 'New York',
                state: 'NY',
                country: 'USA',
                latitude: 40.7128,
                longitude: -74.0060,
                rt: 1.15,
                r0: 1.3,
                hospitalization_rate: 5.8
            },
            {
                week: 'Wk 44',
                cases: 58,
                city_name: 'New York',
                state: 'NY',
                country: 'USA',
                latitude: 40.7128,
                longitude: -74.0060,
                rt: 1.15,
                r0: 1.3,
                hospitalization_rate: 5.8
            }
        ];

        document.addEventListener('DOMContentLoaded', function() {
            try {
                console.log('React version:', React.version);
                console.log('Redux version:', Redux.version);
                console.log('KeplerGl available:', typeof KeplerGl !== 'undefined');
                
                if (typeof KeplerGl === 'undefined') {
                    throw new Error('KeplerGl not loaded');
                }

                // Create Redux store for Kepler.gl
                const reducers = Redux.combineReducers({
                    keplerGl: KeplerGl.keplerGlReducer
                });

                const middlewares = KeplerGl.enhanceReduxMiddleware([]);
                const enhancers = Redux.applyMiddleware(...middlewares);
                keplerStore = Redux.createStore(reducers, {}, Redux.compose(enhancers));

                // Create Kepler.gl component
                const KeplerElement = React.createElement('div', {
                    style: {position: 'absolute', left: 0, width: '100%', height: '100%'}
                }, React.createElement(KeplerGl.KeplerGl, {
                    id: 'kepler-map',
                    width: window.innerWidth,
                    height: window.innerHeight,
                    mapboxApiAccessToken: 'pk.eyJ1IjoibWFwYm94IiwiYSI6ImNpejY4NXVycTA2emYycXBndHRqcmZ3N3gifQ.rJcFIG214AriISLbB6B5aw'
                }));

                const app = React.createElement(ReactRedux.Provider, {store: keplerStore}, KeplerElement);
                
                const root = ReactDOM.createRoot(document.getElementById('map'));
                root.render(app);
                keplerComponent = root;
                
                console.log('Kepler.gl initialized successfully');
                
                // Auto-load sample data after a short delay
                setTimeout(() => {
                    loadSampleData();
                }, 2000);
                
            } catch (error) {
                console.error('Error initializing Kepler.gl:', error);
                document.getElementById('map').innerHTML = '<div style="padding: 20px; color: red;">Error: ' + error.message + '</div>';
            }
        });

        function loadSampleData() {
            try {
                if (!keplerStore) {
                    console.error('Kepler.gl store not initialized');
                    return;
                }

                // Convert data to Kepler.gl format
                const keplerDataset = {
                    data: sampleCityData,
                    info: {
                        id: 'city-epidemiological-data',
                        label: 'New York Epidemiological Data',
                        columns: [
                            {name: 'week', type: 'string'},
                            {name: 'cases', type: 'integer'},
                            {name: 'city_name', type: 'string'},
                            {name: 'state', type: 'string'},
                            {name: 'country', type: 'string'},
                            {name: 'latitude', type: 'real'},
                            {name: 'longitude', type: 'real'},
                            {name: 'rt', type: 'real'},
                            {name: 'r0', type: 'real'},
                            {name: 'hospitalization_rate', type: 'real'}
                        ]
                    }
                };

                // Dispatch action to add data to Kepler.gl
                if (KeplerGl.addDataToMap) {
                    keplerStore.dispatch(KeplerGl.addDataToMap({
                        datasets: [keplerDataset],
                        options: {
                            autoCreateLayers: true,
                            centerMap: true
                        }
                    }));
                    console.log('Sample data loaded into Kepler.gl successfully');
                } else {
                    console.error('KeplerGl.addDataToMap not available');
                }
            } catch (error) {
                console.error('Error loading sample data:', error);
            }
        }

        function clearData() {
            try {
                if (keplerStore && KeplerGl.replaceDataInMap) {
                    keplerStore.dispatch(KeplerGl.replaceDataInMap([]));
                    console.log('Data cleared from Kepler.gl');
                }
            } catch (error) {
                console.error('Error clearing data:', error);
            }
        }
    </script>
</body>
</html>
